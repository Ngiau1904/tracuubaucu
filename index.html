<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tra cứu khu vực bầu cử</title>

<style>
body { font-family: Arial; margin:0; background:#f2f2f2; text-align:center; }
header { background:#c40000; color:white; padding:15px; font-size:22px; font-weight:bold; }
.subheader { background:white; padding:15px; border-bottom:3px solid #c40000; }
.search-box { margin:25px; }
input { padding:12px; width:250px; font-size:16px; }
button { padding:10px 18px; margin:8px; font-size:15px; background:#c40000; color:white; border:none; cursor:pointer; }
button:hover { background:#a00000; }
.result { margin:20px auto; font-size:16px; background:white; padding:20px; width:90%; max-width:500px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
iframe { width:100%; height:60vh; border:none; }
.modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); }
.modal-content { background:white; margin:10% auto; padding:20px; width:90%; max-width:500px; border-radius:8px; text-align:left; }
.close { float:right; font-size:22px; cursor:pointer; color:red; }
</style>
</head>

<body>

<header>ỦY BAN NHÂN DÂN XÃ BÌNH HƯNG</header>

<div class="subheader">
  <h2>TRA CỨU KHU VỰC BẦU CỬ</h2>
  Phục vụ kỳ bầu cử đại biểu nhiệm kỳ 2026 - 2031
</div>

<div class="search-box">
<input type="text" id="searchInput" placeholder="Nhập số Ấp (ví dụ: 6)">
<br>
<button onclick="searchArea()">Tìm kiếm</button>
</div>

<div class="result" id="result"></div>

<iframe src="https://www.google.com/maps/d/u/0/embed?mid=1gITwU3d380FC3IX0FIsakBIetcsY_o4&ehbc=2E312F"></iframe>

<div id="candidateModal" class="modal">
<div class="modal-content">
<span class="close" onclick="closeModal()">×</span>
<div id="candidateInfo"></div>
</div>
</div>

<script>

let donViData = {};
let ungVienData = {};
let dataLoaded = false;

/* ================= LOAD KHU VỰC ================= */

fetch("khuvuc.csv")
.then(res => res.text())
.then(data => {

  const rows = data.replace(/^\uFEFF/, '').split(/\r?\n/);

  rows.slice(1).forEach(row => {

    if(!row.trim()) return;

    const cols = row.split(",");

    if(cols.length < 5) return;

    const donVi = cols[0].trim();
    const khuVuc = cols[1].trim();
    const apList = cols[2];
    const diaDiem = cols[3].trim();
    const latlng = cols[4].trim();

    if(!donViData[donVi]){
      donViData[donVi] = {
        ten: "Đơn vị bầu cử số " + donVi,
        khuVuc: {}
      };
    }

    donViData[donVi].khuVuc[khuVuc] = {
      ten: "Khu vực số " + khuVuc,
      location: diaDiem,
      mapLink: `https://www.google.com/maps/dir/?api=1&destination=${latlng}`,
      ap: apList
            .split(";")
            .map(a => a.replace(/\D/g,""))
            .filter(a => a !== "")
    };

  });

  dataLoaded = true;
});

/* ================= LOAD ỨNG VIÊN ================= */

fetch("ungvien.csv")
.then(res => res.text())
.then(data => {

  const rows = data.replace(/^\uFEFF/, '').split(/\r?\n/).slice(1);

  rows.forEach(row => {

    if(!row.trim()) return;

    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if(!cols || cols.length < 3) return;

    const donVi = cols[0].trim();
    const hoTen = cols[1].replace(/"/g,"").trim();
    const chucVu = cols[2].replace(/"/g,"").trim();

    if(!ungVienData[donVi]){
      ungVienData[donVi] = [];
    }

    ungVienData[donVi].push({hoTen, chucVu});

  });

});

/* ================= SEARCH ================= */

function searchArea(){

  const resultDiv = document.getElementById("result");

  if(!dataLoaded){
    resultDiv.innerHTML = "Đang tải dữ liệu, vui lòng thử lại...";
    return;
  }

  const input = document.getElementById("searchInput").value.trim();

  if(!input){
    resultDiv.innerHTML = "Vui lòng nhập số ấp.";
    return;
  }

  for(let dv in donViData){

    for(let kv in donViData[dv].khuVuc){

      const khu = donViData[dv].khuVuc[kv];

      const found = khu.ap.find(a =>
        parseInt(a) === parseInt(input)
      );

      if(found){
        resultDiv.innerHTML = `
          <b>${donViData[dv].ten}</b><br>
          ${khu.ten}<br>
          Địa điểm: ${khu.location}<br><br>
          <button onclick="window.open('${khu.mapLink}','_blank')">Chỉ đường</button>
          <button onclick="showCandidates('${dv}')">Danh sách ứng cử viên</button>
        `;
        return;
      }
    }
  }

  resultDiv.innerHTML = "Không tìm thấy ấp.";
}

/* ================= MODAL ================= */

function showCandidates(dv){

  const list = ungVienData[dv] || [];

  let html = "<h3>Danh sách ứng cử viên</h3><ul>";

  list.forEach(c=>{
    html += `<li><b>${c.hoTen}</b><br><i>${c.chucVu}</i></li><br>`;
  });

  html += "</ul>";

  document.getElementById("candidateInfo").innerHTML = html;
  document.getElementById("candidateModal").style.display="block";
}

function closeModal(){
  document.getElementById("candidateModal").style.display="none";
}

</script>

</body>
</html>
