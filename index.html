<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra cứu khu vực bầu cử</title>

<style>
:root{
  --primary:#c40000;
  --primary-dark:#a00000;
  --radius:10px;
}

body{
  font-family: Arial, sans-serif;
  margin:0;
  background:#f2f2f2;
  text-align:center;
}

header{
  background:var(--primary);
  color:white;
  padding:15px;
  font-size:22px;
  font-weight:bold;
}

.subheader{
  background:white;
  padding:15px;
  border-bottom:3px solid var(--primary);
}

.search-box{
  margin:25px;
}

input{
  padding:12px;
  width:100%;
  max-width:300px;
  font-size:16px;
}

button{
  padding:10px 18px;
  margin:8px;
  font-size:15px;
  background:var(--primary);
  color:white;
  border:none;
  cursor:pointer;
  border-radius:var(--radius);
  transition:.2s;
}

button:hover{
  background:var(--primary-dark);
}

.result{
  margin:20px auto;
  font-size:16px;
  background:white;
  padding:20px;
  width:90%;
  max-width:500px;
  border-radius:var(--radius);
  box-shadow:0 5px 20px rgba(0,0,0,0.08);
}

iframe{
  width:100%;
  height:60vh;
  border:none;
}

.modal{
  display:none;
  position:fixed;
  z-index:999;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
}

.modal-content{
  background:white;
  margin:8% auto;
  padding:20px;
  width:90%;
  max-width:500px;
  border-radius:var(--radius);
  text-align:left;
  max-height:70vh;
  overflow-y:auto;
}

.close{
  float:right;
  font-size:22px;
  cursor:pointer;
  color:var(--primary);
  font-weight:bold;
}
</style>
</head>

<body>

<header>ỦY BAN NHÂN DÂN XÃ BÌNH HƯNG</header>

<div class="subheader">
  <h2>TRA CỨU KHU VỰC BẦU CỬ</h2>
  PHỤC VỤ KỲ BẦU CỬ ĐẠI BIỂU HỘI ĐỒNG NHÂN DÂN XÃ BÌNH HƯNG NHIỆM KỲ 2026 – 2031
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Nhập số Ấp (ví dụ: 6)">
  <br>
  <button id="searchBtn">Tìm kiếm</button>
</div>

<div class="result" id="result"></div>

<iframe src="https://www.google.com/maps/d/u/0/embed?mid=1gITwU3d380FC3IX0FIsakBIetcsY_o4&ehbc=2E312F"></iframe>

<div id="candidateModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModalBtn">×</span>
    <div id="candidateInfo"></div>
  </div>
</div>

<script>

let donViData = {};
let ungVienData = {};
let dataLoaded = false;

/* ================= LOAD DATA ================= */

Promise.all([
  fetch("khuvuc.csv").then(res=>res.text()),
  fetch("ungvien.csv").then(res=>res.text())
])
.then(([khuvucCSV, ungvienCSV])=>{

  /* ===== LOAD KHU VỰC ===== */
  const rows = khuvucCSV.replace(/^\uFEFF/, '').split(/\r?\n/);

  rows.slice(1).forEach(row=>{
    if(!row.trim()) return;

    const cols = row.split(",");
    if(cols.length < 5) return;

    const donVi = cols[0].trim();
    const khuVuc = cols[1].trim();
    const apList = cols[2];
    const diaDiem = cols[3].trim();
    const latlngRaw = cols[4];

    if(!donViData[donVi]){
      donViData[donVi] = {
        ten: "Đơn vị bầu cử số " + donVi,
        khuVuc: {}
      };
    }

    const latlngClean = latlngRaw.replace(/"/g,"").trim();
    const parts = latlngClean.split(/[,|\s]+/);

    let lat = null;
    let lng = null;

    if(parts.length >= 2){
      lat = parseFloat(parts[0]);
      lng = parseFloat(parts[1]);
    }

    if(isNaN(lat) || isNaN(lng)){
      console.error("Sai định dạng tọa độ:", latlngClean);
      return;
    }

    donViData[donVi].khuVuc[khuVuc] = {
      ten: "Khu vực bỏ phiếu số " + khuVuc,
      location: diaDiem,
      lat: lat,
      lng: lng,
      ap: apList.split(";")
        .map(a => a.replace(/\D/g,""))
        .filter(a => a !== "")
    };
  });

  /* ===== LOAD ỨNG VIÊN ===== */
  const rows2 = ungvienCSV.replace(/^\uFEFF/, '').split(/\r?\n/).slice(1);

  rows2.forEach(row=>{
    if(!row.trim()) return;

    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if(!cols || cols.length < 3) return;

    const donVi = cols[0].trim();
    const hoTen = cols[1].replace(/"/g,"").trim();
    const chucVu = cols[2].replace(/"/g,"").trim();

    if(!ungVienData[donVi]){
      ungVienData[donVi] = [];
    }

    ungVienData[donVi].push({hoTen, chucVu});
  });

  dataLoaded = true;
})
.catch(err=>{
  console.error("Lỗi load dữ liệu:", err);
});

/* ================= SEARCH ================= */

function searchArea(){

  const resultDiv = document.getElementById("result");

  if(!dataLoaded){
    resultDiv.textContent = "Đang tải dữ liệu, vui lòng thử lại...";
    return;
  }

  const input = document.getElementById("searchInput").value.trim();

  if(!input){
    resultDiv.textContent = "Vui lòng nhập số ấp.";
    return;
  }

  for(let dv in donViData){
    for(let kv in donViData[dv].khuVuc){

      const khu = donViData[dv].khuVuc[kv];

      const found = khu.ap.find(a =>
        parseInt(a) === parseInt(input)
      );

      if(found){
        resultDiv.innerHTML = `
          <b>${donViData[dv].ten}</b><br>
          ${khu.ten}<br>
          Địa điểm: ${khu.location}<br><br>
          <button id="dirBtn">Chỉ đường</button>
          <button id="candidateBtn">Danh sách ứng cử viên</button>
        `;

        document.getElementById("dirBtn")
          .addEventListener("click", ()=>chiDuong(khu.lat, khu.lng));

        document.getElementById("candidateBtn")
          .addEventListener("click", ()=>showCandidates(dv));

        return;
      }
    }
  }

  resultDiv.textContent = "Không tìm thấy ấp.";
}

/* ================= CHỈ ĐƯỜNG ================= */

function chiDuong(lat, lng){

  if(isNaN(lat) || isNaN(lng)){
    alert("Tọa độ không hợp lệ.");
    return;
  }

  if(!navigator.geolocation){
    alert("Trình duyệt không hỗ trợ định vị.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function(position){

      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;

      const url =
        "https://www.google.com/maps/dir/?api=1" +
        "&origin=" + userLat + "," + userLng +
        "&destination=" + lat + "," + lng +
        "&travelmode=driving";

      window.location.href = url;
    },
    function(error){
      alert("Không lấy được vị trí: " + error.message);
    },
    {
      enableHighAccuracy:true,
      timeout:15000,
      maximumAge:0
    }
  );
}

/* ================= MODAL ================= */

function showCandidates(dv){

  const list = ungVienData[dv] || [];

  let html = "<h3>Danh sách ứng cử viên</h3><ul>";

  list.forEach(c=>{
    html += `<li><b>${c.hoTen}</b><br><i>${c.chucVu}</i></li><br>`;
  });

  html += "</ul>";

  document.getElementById("candidateInfo").innerHTML = html;
  document.getElementById("candidateModal").style.display="block";
}

function closeModal(){
  document.getElementById("candidateModal").style.display="none";
}

/* ================= EVENT LISTENER ================= */

document.getElementById("searchBtn")
  .addEventListener("click", searchArea);

document.getElementById("searchInput")
  .addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      searchArea();
    }
  });

document.getElementById("closeModalBtn")
  .addEventListener("click", closeModal);

window.addEventListener("click", function(e){
  const modal = document.getElementById("candidateModal");
  if(e.target === modal){
    closeModal();
  }
});

</script>

</body>
</html>
