<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tra cứu khu vực bầu cử</title>

<style>
:root{
  --primary:#c40000;
  --primary-dark:#a00000;
  --radius:10px;
}

body{
  font-family: Arial, sans-serif;
  margin:0;
  background:#f2f2f2;
  text-align:center;
}

header{
  background:var(--primary);
  color:white;
  padding:15px;
  font-size:22px;
  font-weight:bold;
}

.subheader{
  background:white;
  padding:15px;
  border-bottom:3px solid var(--primary);
}

.search-box{
  margin:25px;
}

input{
  padding:12px;
  width:100%;
  max-width:300px;
  font-size:16px;
}

button{
  padding:10px 18px;
  margin:8px;
  font-size:15px;
  background:var(--primary);
  color:white;
  border:none;
  cursor:pointer;
  border-radius:var(--radius);
  transition:.2s;
}

button:hover{
  background:var(--primary-dark);
}

.result{
  margin:20px auto;
  font-size:16px;
  background:white;
  padding:20px;
  width:90%;
  max-width:500px;
  border-radius:var(--radius);
  box-shadow:0 5px 20px rgba(0,0,0,0.08);
  line-height:1.6; 
}

iframe{
  width:100%;
  height:60vh;
  border:none;
}

/* ===== MODAL ===== */

.modal{
  display:none;
  position:fixed;
  z-index:999;
  left:0;
  top:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
}

.modal-content{
  background:white;
  margin:6% auto;
  width:90%;
  max-width:550px;
  border-radius:var(--radius);
  overflow:hidden;
  animation:fadeIn .25s ease;
  max-height:80vh;
  display:flex;
  flex-direction:column;
}

@keyframes fadeIn{
  from{transform:translateY(-10px);opacity:0;}
  to{transform:translateY(0);opacity:1;}
}

.modal-header{
  background:var(--primary);
  color:white;
  padding:14px 20px;
  font-weight:bold;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.modal-body{
  padding:20px;
  overflow-y:auto;
}

/* ===== CANDIDATE CARD ===== */

.candidate-item{
  padding:16px 18px;
  margin-bottom:14px;
  border-radius:10px;
  background:#ffffff;
  border:1px solid #e5e5e5;
  box-shadow:0 3px 12px rgba(0,0,0,0.05);
  transition:all .2s ease;
  position:relative;
}

.candidate-item:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(0,0,0,0.08);
  border-color:var(--primary);
}

.candidate-number{
  position:absolute;
  top:12px;
  right:14px;
  background:var(--primary);
  color:white;
  font-size:13px;
  padding:3px 8px;
  border-radius:20px;
  font-weight:bold;
}

.candidate-name{
  font-weight:700;
  font-size:17px;
  margin-bottom:6px;
  color:#222;
}

.candidate-role{
  font-size:14px;
  color:#555;
  line-height:1.6;
}

.close{
  font-size:20px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<header>ỦY BAN NHÂN DÂN XÃ BÌNH HƯNG</header>

<div class="subheader">
  <h2>TRA CỨU KHU VỰC BẦU CỬ</h2>
  Phục vụ kỳ bầu cử đại biểu nhiệm kỳ 2026 - 2031
</div>

<div class="search-box">
  <input type="text" id="searchInput" placeholder="Nhập số Ấp (ví dụ: 6)">
  <br>
  <button id="searchBtn">Tìm kiếm</button>
</div>

<div class="result" id="result"></div>

<iframe src="https://www.google.com/maps/d/u/0/embed?mid=1gITwU3d380FC3IX0FIsakBIetcsY_o4&ehbc=2E312F"></iframe>

<!-- MODAL -->
<div id="candidateModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span>Danh sách ứng cử viên</span>
      <span class="close" id="closeModalBtn">×</span>
    </div>
    <div class="modal-body" id="candidateInfo"></div>
  </div>
</div>

<script>

let donViData = {};
let ungVienData = {};
let dataLoaded = false;

/* LOAD DATA */

Promise.all([
  fetch("khuvuc.csv").then(res=>res.text()),
  fetch("ungvien.csv").then(res=>res.text())
])
.then(([khuvucCSV, ungvienCSV])=>{

  const rows = khuvucCSV.replace(/^\uFEFF/, '').split(/\r?\n/);

  rows.slice(1).forEach(row=>{
    if(!row.trim()) return;

    const cols = row.split(",");
    if(cols.length < 5) return;

    const donVi = cols[0].trim();
    const khuVuc = cols[1].trim();
    const apList = cols[2];
    const diaDiem = cols[3].trim();
    const latlngRaw = cols[4];

    if(!donViData[donVi]){
      donViData[donVi] = {
        ten: "Đơn vị bầu cử số " + donVi,
        khuVuc: {}
      };
    }

    const latlngClean = latlngRaw.replace(/"/g,"").trim();
    const parts = latlngClean.split(/[,|\s]+/);

    let lat = parseFloat(parts[0]);
    let lng = parseFloat(parts[1]);

    if(isNaN(lat) || isNaN(lng)) return;

    donViData[donVi].khuVuc[khuVuc] = {
      ten: "Khu vực bỏ phiếu số " + khuVuc,
      location: diaDiem,
      lat: lat,
      lng: lng,
      ap: apList.split(";")
        .map(a => a.replace(/\D/g,""))
        .filter(a => a !== "")
    };
  });

  const rows2 = ungvienCSV.replace(/^\uFEFF/, '').split(/\r?\n/).slice(1);

  rows2.forEach(row=>{
    if(!row.trim()) return;

    const cols = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
    if(!cols || cols.length < 3) return;

    const donVi = cols[0].trim();
    const hoTen = cols[1].replace(/"/g,"").trim();
    const chucVu = cols[2].replace(/"/g,"").trim();

    if(!ungVienData[donVi]){
      ungVienData[donVi] = [];
    }

    ungVienData[donVi].push({hoTen, chucVu});
  });

  dataLoaded = true;
})
.catch(err=>console.error(err));

/* SEARCH */

function searchArea(){

  const resultDiv = document.getElementById("result");

  if(!dataLoaded){
    resultDiv.textContent = "Đang tải dữ liệu...";
    return;
  }

  const input = document.getElementById("searchInput").value.trim();

  if(!input){
    resultDiv.textContent = "Vui lòng nhập số ấp.";
    return;
  }

  for(let dv in donViData){
    for(let kv in donViData[dv].khuVuc){

      const khu = donViData[dv].khuVuc[kv];

      const found = khu.ap.find(a =>
        parseInt(a) === parseInt(input)
      );

      if(found){
        resultDiv.innerHTML = `
          <b>${donViData[dv].ten}</b><br>
          ${khu.ten}<br>
          Địa điểm: ${khu.location}<br><br>
          <button id="dirBtn">Chỉ đường</button>
          <button id="candidateBtn">Danh sách ứng cử viên</button>
        `;

        document.getElementById("dirBtn")
          .addEventListener("click", ()=>chiDuong(khu.lat, khu.lng));

        document.getElementById("candidateBtn")
          .addEventListener("click", ()=>showCandidates(dv));

        return;
      }
    }
  }

  resultDiv.textContent = "Không tìm thấy ấp.";
}

/* SHOW CANDIDATES */

function showCandidates(dv){

  const list = ungVienData[dv] || [];
  let html = "";

  list.forEach((c,index)=>{
    html += `
      <div class="candidate-item">
        <div class="candidate-number">${index+1}</div>
        <div class="candidate-name">${c.hoTen}</div>
        <div class="candidate-role">${c.chucVu}</div>
      </div>
    `;
  });

  document.getElementById("candidateInfo").innerHTML = html;
  document.getElementById("candidateModal").style.display="block";
}

function closeModal(){
  document.getElementById("candidateModal").style.display="none";
}

/* CHỈ ĐƯỜNG */

function chiDuong(lat,lng){

  navigator.geolocation.getCurrentPosition(
    function(position){
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;

      const url =
        "https://www.google.com/maps/dir/?api=1" +
        "&origin=" + userLat + "," + userLng +
        "&destination=" + lat + "," + lng +
        "&travelmode=driving";

      window.location.href = url;
    }
  );
}

/* EVENTS */

document.getElementById("searchBtn")
  .addEventListener("click", searchArea);

document.getElementById("searchInput")
  .addEventListener("keydown", e=>{
    if(e.key==="Enter") searchArea();
  });

document.getElementById("closeModalBtn")
  .addEventListener("click", closeModal);

window.addEventListener("click", e=>{
  const modal=document.getElementById("candidateModal");
  if(e.target===modal) closeModal();
});

</script>

</body>
</html>


